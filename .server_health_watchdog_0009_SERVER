#!/bin/bash
# v1.0 vdrserver

#System Fitness testen und externen Watchdog versorgen

. /etc/vectra130/configs/sysconfig/.sysconfig

healthFail=0

#Frontend Empfang testen
if [[ $(tail -100 /var/log/syslog | grep 'timed out while' | wc -l) -gt 0 || $(tail -100 /var/log/syslog | grep -i 'video data stream broken' | wc -l) -gt 0 ]]; then
	healthFail=1
	logger -t HEALTH "Frontend meldet $(tail -100 /var/log/syslog | grep -i 'video data stream broken' | wc  -l) VDSB und $(tail -100 /var/log/syslog | grep 'tuned out while' | wc -l) FTO Fehler unter den letzten 100 Syslog Eintraegen"
fi

#streaming server testen
if [ $(echo 'quit' | nc -q 1 $IP 2004 | grep ^220 | wc -l) == 0 ]; then
	healthFail=1
	logger -t HEALTH " Streamdev Server ist nicht erreichbar"
fi

#Daemons testen
for daemon in vdr ; do
	if [ $(pidof -xs $daemon | wc -w) == 0 ]; then
		healthFail=1
		logger -t HEALTH "Daemon '$daemon' laeuft nicht"
	fi
done

if [ $healthFail != 0 ]; then
	tail -20 /var/log/syslog | grep HEALTH >> /etc/vectra130/health_test
fi
